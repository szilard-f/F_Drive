<!DOCTYPE html> 
<html lang="hu">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="./static/images/logo.png" type="image/png" />
    <link rel="shortcut icon" href="./static/images/logo.png" type="image/png" />
    <title>FF_túraadatok – részletes lekérdezés</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />

    <style>
        :root{
            --ink:#182433;
            --muted:#5b6b7e;
            --brand:#e94f3b;
            --blue:#0888c8;
            --blue-hover:#077ab4;
            --surface: rgba(255,255,255,.70);
            --overlay: rgba(255,255,255,.70);
            --radius:24px;
            --shadow:0 10px 30px rgba(0,0,0,.15);
            --logo-size: 100px;
            --logo-stack-gap-desktop: 6px;
            --logo-stack-gap-mobile: -6px;
        }

        #search-input::placeholder,
        #street-input::placeholder {
            color: rgba(0,0,0,.12);
            opacity: 1;
        }

        html, body{
            margin:0; padding:0; color:var(--ink);
            font: 400 16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";
            background: url('../fdrive/images/background.jpg') no-repeat center center fixed;
            background-size:cover; min-height:100svh; overflow-y:auto;
        }

        .bg-overlay{ position:fixed; inset:0; background:var(--overlay); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); z-index:0; }
        .shell{ position:relative; z-index:1; min-height:100svh; display:grid; place-content:start center; padding: clamp(20px, 3vw, 40px); }

        .card-app{ width:min(1200px, 96vw); background:var(--surface); border-radius:var(--radius); box-shadow:var(--shadow); padding: clamp(20px, 3.6vw, 40px); animation: floatIn .6s ease-out both; isolation:isolate; position:relative; }
        .card-app::before{ content:""; position:absolute; inset:-2px; border-radius:calc(var(--radius) + 2px);
            background: radial-gradient(1200px 300px at 50% -40%, rgba(233,79,59,.18), transparent 55%),
                        radial-gradient(1200px 300px at 50% 140%, rgba(0,153,255,.12), transparent 55%);
            filter: blur(12px); z-index:-1; }
        @keyframes floatIn{ from{ transform: translateY(16px); opacity:0; } to{ transform: translateY(0); opacity:1; } }

        .app-header{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 0; }
        .app-title{ margin:0; font-weight:800; letter-spacing:.2px; font-size: clamp(20px, 2.2vw + 8px, 32px); }
        .app-title .red{ color: var(--brand); font-weight: 900; }
        .app-title .blue{ color: var(--blue); font-weight: 900; }

        .logo-container img{ width: var(--logo-size); height:auto; filter: drop-shadow(0 3px 10px rgba(0,0,0,.12)); }

        .subhead{ display:flex; align-items:center; justify-content:flex-end; gap:12px; margin-top: var(--logo-stack-gap-desktop); }
        .subtitle{ margin:0; color: var(--muted); font-size: clamp(14px, 1.1vw + 10px, 18px); }

        .filters{ margin-top: 10px; margin-bottom: 6px; }
        .filters .form-group{ margin-bottom: 0; }
        .filters .form-row{ align-items: flex-end; }
        .filters .form-control{ height:44px; padding:10px 12px; box-sizing:border-box; }
        .ui-autocomplete-input{ line-height:1.25; }
        .hint{ color: var(--muted); font-size: .9rem; }

        .btn-pill{ appearance:none; border:none; border-radius:999px; padding:10px 16px; font-weight:700; cursor:pointer;
                   box-shadow:0 6px 16px rgba(0,0,0,.08); transition: transform .05s ease, box-shadow .2s ease, background .15s ease; min-width:160px; text-align:center; }
        .btn-pill.primary{ background: var(--blue); color:#fff; }
        .btn-pill.primary:hover{ background: var(--blue-hover); }
        .btn-pill.danger{ background: var(--brand); color:#fff; }
        .btn-pill:active{ transform: translateY(1px); }

        .btn-grid{ display:flex; justify-content:center; align-items:center; gap:12px; flex-wrap:wrap; }
        .btn-grid .btn-pill{ min-width: 140px; }

        .divider{ margin: 16px auto 16px; height:1px; width:min(520px, 70%); background: linear-gradient(90deg, transparent, rgba(0,0,0,.12), transparent); }

        #results, #details { display: none; }
        #results:not(:empty), #details:not(:empty) {
            display: block;
            background: rgba(255,255,255,.72);
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 3px 12px rgba(0,0,0,.06);
        }
        #results:not(:empty){ margin-top: 10px; }
        #details:not(:empty){ margin-top: 12px; }

        .desktop-only { display:block; }

        table.table{ border-collapse: separate; border-spacing: 0 0.1px; background: transparent; }
        table.table th{ text-align:center !important; vertical-align: middle; background: rgba(0,0,0,.04); }
        table.table td, table.table th{ border-color: rgba(0,0,0,.08) !important; }

        .mobile-only { display:none !important; }
        .result-cards { display:none; gap:12px; }
        .result-card { background: rgba(255,255,255,.9); border-radius: 14px; box-shadow: 0 4px 14px rgba(0,0,0,.08); padding: 12px 12px 10px; }
        .rc-head { font-weight:800; margin:0 0 6px; }
        .rc-row  { font-size:.95rem; color:var(--ink); }
        .rc-row + .rc-row { margin-top:4px; }
        .rc-meta { color: var(--muted); font-size:.9rem; margin-top:4px; }
        .rc-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap; }
        .rc-actions .btn-pill{ min-width: 128px; padding:8px 14px; }

        .inactive-highlight{ background-color: rgba(255, 0, 0, 0.10); outline: 2px solid var(--brand); outline-offset: -2px; border-radius: 10px; padding: 0.25em; transition: background-color 0.3s ease; }
        .inactive-highlight td{ background-color: rgba(255,0,0,.06); }

        .turalista-list .depot-header{ margin-top: 1rem; color: var(--brand); font-size: 1.1rem; font-weight: 800; }
        .turalista-list .autó{ margin-left: 1rem; font-size: 1rem; font-weight: 700; }
        .turalista-list .trip-line{ margin-left: 1.5rem; }

        .special-task-btn{ min-width: 260px; }
        .special-center{ text-align:center; }
        .special-hint{ margin-top: 8px; text-align:center; color: var(--muted); font-size: .9rem; }
        .special-progress{ display:flex; justify-content:center; align-items:center; font-weight:bold; margin:10px auto; min-width:260px; text-align:center; }
        .special-progress .dots{ display:inline-block; width:5ch; text-align:left; font-family:monospace; }

        .maintenance-overlay{ display:none; position:fixed; z-index:9999; inset:0; background:var(--overlay); text-align:center; justify-content:center; align-items:center; }
        .maintenance-box{ background: rgba(255,255,255,.80); padding: clamp(20px, 3vw, 36px); border-radius: var(--radius); box-shadow: var(--shadow); max-width: 640px; margin: 20px; }
        .maintenance-box h1{ font-size: clamp(20px, 2.2vw + 8px, 30px); margin-bottom: 6px; }
        .countdown{ font-size: 1.4rem; color: var(--brand); margin-top: 8px; }

        .text-muted-2{ color: var(--muted); }
        .red{ color: var(--brand); font-weight: 800; }
        .blue{ color: var(--blue); font-weight: 800; }

        @media (max-width: 992px){
            html, body{ background-attachment: scroll; }
            .card-app{ border-radius: 16px; padding: 18px; }
            .logo-container img{ width: 74px; }
            .subhead{ margin-top: var(--logo-stack-gap-mobile); }
            .d-flex.align-items-center {justify-content: center; }
            .btn-grid{ flex-direction: column; align-items: stretch; }
            .btn-grid .btn-pill{ width: 100%; min-width: 0; }
            #results, #details{ border-radius: 12px; }
            .filters .form-control {margin-bottom: 8px;} 
            .desktop-only { display:none !important; }
            .mobile-only  { display:block !important; }
            .result-cards { display:grid; }
            .btn-pill{ width: auto; min-width: 140px; }
        }

        @media (prefers-reduced-motion: reduce){ *{ animation:none !important; transition:none !important; } }

        .filters .form-row{ display:flex; gap:16px; justify-content:center; margin-left:auto; margin-right:auto; max-width:1100px; }
        .filters .form-row > [class*="col-"]{ padding-left:0; padding-right:0; }
        .filters .form-row .form-group{ flex:1 1 0; min-width:0; }
        .filters .form-row .form-control{ width:100%; }
        @media (max-width: 991.98px){
            .filters .form-row{ flex-direction:column; max-width:720px; }
        }

        .btn-label{ display:inline; }
        @media (max-width: 576px){
            .btn-grid{ flex-direction: row; align-items:center; justify-content: center; gap:8px; }
            .btn-grid .btn-pill{ flex:1 1 0; min-width:0; padding:8px 10px; border-radius:12px; }
            .btn-grid .btn-pill i{ margin:0; font-size:18px; }
            .btn-label{ display:none; }
            #clear-btn{ order:1; }
            #map-btn{ order:2; }
            #search-btn{ order:3; }
        }
    </style>
</head>

<body>
    <div class="bg-overlay" aria-hidden="true"></div>

    <div class="maintenance-overlay" id="maintenance-overlay" role="dialog" aria-labelledby="maint-title" aria-modal="true">
        <div class="maintenance-box">
            <h1 id="maint-title">⛔ Jelenleg karbantartás zajlik ⛔</h1>
            <div>Várható újraindítás: <strong id="target-time">2025.08.29 08:00:00</strong></div>
            <div class="countdown" id="countdown-timer">00:00:00</div>
        </div>
    </div>

    <main class="shell" id="app" role="main">
        <section class="card-app" aria-labelledby="title">
            <header class="app-header">
                <h1 id="title" class="app-title">
                    <span class="red">F</span><span class="blue">F</span>_túraadatok&nbsp;–&nbsp;részletes lekérdezés
                </h1>
                <div class="logo-container">
                    <img src="./static/images/fflogo.png" alt="FF logo" />
                </div>
            </header>

            <div class="subhead">
                <div class="logo-container">
                    <img src="./static/images/fdlogo.png" alt="F_Drive logo" />
                </div>
            </div>

            <div class="divider" aria-hidden="true"></div>

            <section class="filters" aria-label="Szűrési feltételek">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="search-input" class="mb-1">Település vagy irányítószám</label>
                        <input type="text" id="search-input" class="form-control" placeholder="pl. Budapest vagy 1037" />
                    </div>
                    <div class="form-group col-md-6">
                        <label for="street-input" class="mb-1">Közterület (opcionális)</label>
                        <input type="text" id="street-input" class="form-control" placeholder="pl. József Attila utca" />
                    </div>
                </div>
                <div class="btn-grid mb-2 mt-3">
                    <button id="search-btn" class="btn-pill primary"><i class="fas fa-search"></i> <span class="btn-label">Keresés</span></button>
                    <button id="clear-btn" class="btn-pill danger"><i class="fas fa-trash-alt"></i> <span class="btn-label">Törlés</span></button>
                    <button id="map-btn" class="btn-pill primary"><i class="fas fa-map-marked-alt"></i> <span class="btn-label">Térkép</span></button>
                </div>
            </section>

            <div class="divider" aria-hidden="true"></div>

            <section>
                <div id="results"></div>
                <pre id="resultsPlain" style="display:none; background:#f8f9fa; padding:1em;"></pre>
                <div id="details"></div>
            </section>
        </section>
    </main>

    <script>
        const rawTime = document.getElementById("target-time").textContent.trim();
        const formattedTime = rawTime.replace(/\./g, "-").replace(" ", "T");
        const targetDate = new Date(formattedTime);
        const now = new Date();
        const maintenanceMode = now < targetDate;

        function updateCountdown(){
            const now = new Date();
            const diff = targetDate - now;
            if (diff <= 0){
                document.getElementById("countdown-timer").innerText = "Karbantartás véget ért. Frissítés...";
                setTimeout(() => location.reload(), 2000);
                return;
            }
            const days = Math.floor(diff / (1000*60*60*24));
            const hours = Math.floor((diff / (1000*60*60)) % 24);
            const minutes = Math.floor((diff / (1000*60)) % 60);
            const seconds = Math.floor((diff / 1000) % 60);
            document.getElementById("countdown-timer").innerText = `${days} nap ${hours} óra ${minutes} perc ${seconds} mp`;
        }

        if (maintenanceMode){
            const overlay = document.getElementById("maintenance-overlay");
            overlay.style.display = "flex"; overlay.classList.add("d-flex");
            setInterval(updateCountdown, 1000); updateCountdown();
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script>
        if (!maintenanceMode){
            const backendUrl = "https://fabuszilard.myftp.org/turainfo/";
            let exactCityMatch = false;

            function closeMobileKeyboard() {
                const el = document.activeElement;
                if (!el || (el.tagName !== 'INPUT' && el.tagName !== 'TEXTAREA')) return;
                const ua = navigator.userAgent.toLowerCase();
                const isIOS = /iphone|ipad|ipod/.test(ua) || (/mac/.test(ua) && 'ontouchend' in document);
                if (isIOS) {
                    const prev = el.readOnly;
                    el.readOnly = true;
                    setTimeout(() => { el.blur(); el.readOnly = prev; }, 0);
                } else {
                    el.blur();
                }
            }
            document.addEventListener('pointerdown', function(e){
                const t = e.target;
                if (t.closest('input, textarea, .ui-autocomplete, .ui-menu, .ui-menu-item, .ui-widget')) return;
                closeMobileKeyboard();
            }, { capture: true });

            const respKind   = atob("YWRtaW5fbWVuZXRyZW5k");
            const hiddenPath = atob("YWRtaW4vbWVuZXRyZW5k");

            const wA = atob("YWRtaW4");
            const wB = atob("bWVuZXRyZW5k");
            const origBtnCls    = `${wA}-${wB}-btn`;
            const origCenterCls = `${wA}-${wB}-center`;
            const origHintCls   = `${wA}-hint`;
            const origProgCls   = `${wA}-progress`;

            const aliasBtnCls    = "special-task-btn";
            const aliasCenterCls = "special-center";
            const aliasHintCls   = "special-hint";
            const aliasProgCls   = "special-progress";

            function cloakAdminHtml(html){
                const $tmp = $('<div>').html(html || "");
                $tmp.find(`.${origBtnCls}`).each(function(){
                    const $btn = $(this);
                    $btn.addClass(aliasBtnCls).removeClass(origBtnCls);
                    $btn.parent().addClass(aliasCenterCls);
                    const t = $btn.text();
                    $btn.text(t.replace(/menetrend/gi, 'Menetrend'));
                });
                $tmp.find(`.${origCenterCls}`).removeClass(origCenterCls).addClass(aliasCenterCls);
                $tmp.find(`.${origHintCls}`).removeClass(origHintCls).addClass(aliasHintCls);
                $tmp.find(`.${origProgCls}`).removeClass(origProgCls).addClass(aliasProgCls);
                if (!$tmp.find(`.${aliasHintCls}`).length && $tmp.find(`.${aliasBtnCls}`).length){
                    $('<div>', { 'class': aliasHintCls, text: 'A művelet akár percekig is eltarthat.' }).insertAfter($tmp.find(`.${aliasBtnCls}`).first());
                }
                return $tmp.html();
            }

            function buildMobileCards(resp){
                let html = '<div class="result-cards mobile-only">';
                resp.forEach(it => {
                    const head = `${it.depo} • Túra ${it.tour_number}`;
                    const meta = `${it.date} • ${it.time_interval}`;
                    const addr = `${it.city}${it.street ? ' — ' + it.street : ''}`;
                    const plate = it.plate_number || '';
                    html += `
                        <article class="result-card summary" data-depo="${it.depo}" data-tour_number="${it.tour_number}" data-plate="${plate}">
                            <h5 class="rc-head">${head}</h5>
                            <div class="rc-row"><strong>Rendszám:</strong> ${plate || '-'}</div>
                            <div class="rc-row"><strong>Cím:</strong> ${addr}</div>
                            <div class="rc-meta">${meta}</div>
                            <div class="rc-actions">
                                <button class="btn-pill danger pdf-btn">Túraleírás</button>
                            </div>
                        </article>`;
                });
                html += '</div>';
                return html;
            }

            function runSearch(){
                closeMobileKeyboard();
                let q = $('#search-input').val().trim();
                let s = $('#street-input').val().trim();
                
   
                if (q.trim().toLowerCase() === 'admin' && s.trim().toLowerCase() === 'depoall') {
                    const fbBase   = 'https://fabuszilard.myftp.org/filebrowser';
                    const relayUrl = 'https://fabuszilard.myftp.org/turainfo/fb_autologin';
                    fetch('https://fabuszilard.myftp.org/turainfo/depoall_token')
                        .then(r => r.json())
                        .then(data => {
                            const t = data && data.token;
                            if (!t) throw new Error((data && data.error) || 'Nincs token a válaszban.');
                            const relay = `${relayUrl}?t=${encodeURIComponent(t)}`;
                            window.location.href = relay; 
                        })
                        .catch(err => {
                            console.error(err);
                            alert('❌ Bejelentkezési hiba: ' + err.message);
                        });
                    return;
                }
$('#results,#resultsPlain,#details').empty();
                $('#resultsPlain').hide();
                $('.inactive-highlight').removeClass('inactive-highlight');
                if (!q){
                    $('#results').html('<p class="text-muted-2">Kérem adja meg a települést vagy irányítószámot!</p>');
                    return;
                }
                let data = { q, street: s };
                if (exactCityMatch){ data.exact_city = "1"; exactCityMatch = false; }
                $.ajax({
                    url: `${backendUrl}search`,
                    data: data,
                    success: resp => {
                        if (resp && resp.kind === respKind){
                            $('#results').html(cloakAdminHtml(resp.html));
                            return;
                        }
                        if (Array.isArray(resp) && resp.length && typeof resp[0] === 'string' && (resp[0].includes('kilógók:') || resp[0].includes('fő települések:') || resp[0].endsWith(':'))){
                            let html = '<h5>Gyanús, oda nem illő települések depónként és túránként:</h5><div class="turalista-list">';
                            resp.forEach(line => {
                                if (line.endsWith(':')){
                                    html += `<div class="depot-header">${line.replace(/:$/, '')}</div>`;
                                } else if (line.includes('kilógók:')){
                                    const m = line.match(/^(.*kilógók:)(.*?)(\s*\|\s*fő települések:)(.*)$/);
                                    if (m){
                                        html += `<div class="trip-line">${m[1]} <span style="color:#d9534f;font-weight:bold;">${m[2].trim()}</span>${m[3]} <span style="color:#007bff;">${m[4].trim()}</span></div>`;
                                    } else {
                                        html += `<div class="trip-line">${line}</div>`;
                                    }
                                } else if (line.includes('| fő települések:')){
                                    let [left, right] = line.split('| fő települések:');
                                    let [tripNum, outliers] = left.split(':');
                                    html += `<div class="trip-line"><span style="font-weight:bold;">${tripNum}:</span> <span style="color:#d9534f; font-weight:bold;">${outliers.trim()}</span> | fő települések: <span style="color:#007bff;">${right.trim()}</span></div>`;
                                } else {
                                    html += `<div class="trip-line">${line}</div>`;
                                }
                            });
                            html += '</div>';
                            $('#results').html(html);
                            return;
                        }
                        if (Array.isArray(resp) && resp.length && typeof resp[0] === 'string' && resp[0].match(/^\d+: /)){
                            let html = '<h5>Többször szereplő, ellenőrizendő települések:</h5><ul>';
                            resp.forEach(city => html += `<li>${city}</li>`);
                            html += '</ul>';
                            $('#results').html(html);
                            return;
                        }
                        if (Array.isArray(resp) && resp.length && resp.some(line => typeof line === 'string' && line.includes('db ('))){
                            let html = '<h5>60 stop alatti túrák depónként:</h5><div class="turalista-list">';
                            resp.forEach(line => {
                                if (/^\d+\.$/.test(line)){
                                    html += `<div class="depot-header">${line}</div>`;
                                } else if (line.includes('db (')){
                                    html += `<div class="trip-line">${line}</div>`;
                                }
                            });
                            html += '</div>';
                            $('#results').html(html);
                            return;
                        }
                        if (Array.isArray(resp) && resp.length && typeof resp[0] === 'string' && resp[0].match(/^\d+\.$/)){
                            let html = '<h5>Depónkénti túralista:</h5><div class="turalista-list">';
                            resp.forEach(line => {
                                if (/^\d+\.$/.test(line)){
                                    html += `<div class="depot-header">${line}</div>`;
                                } else if (/^\d+$/.test(line)){
                                    html += `<div class="autó">${line}</div>`;
                                } else {
                                    html += `<div class="trip-line">${line}</div>`;
                                }
                            });
                            html += '</div>';
                            $('#results').html(html);
                            return;
                        }
                        if (Array.isArray(resp) && resp.length && resp[0].tours_count !== undefined){
                            let html = '<h5>Depók és feltöltött túraszámok:</h5>';
                            resp.forEach(item => {
                                const total    = Number(item.tours_count) || 0;
                                const inactive = (item.inactive_count != null) ? Number(item.inactive_count) : null;
                                const active   = (item.active_count   != null) ? Number(item.active_count) : (inactive != null ? (total - inactive) : null);
                                html += `
                                    <div class="mb-2">
                                        <div>${item.depo}: ${total} túra</div>
                                        ${active   !== null ? `<div>- <span class="blue" style="font-weight: normal;">aktív: ${active}</span></div>`   : ``}
                                        ${inactive !== null ? `<div>- <span class="red"  style="font-weight: normal;">inaktív: ${inactive}</span></div>` : ``}
                                    </div>
                                `;
                            });
                            $('#results').html(html);
                            return;
                        }
                        if (!resp.length){
                            $('#results').html('<p class="text-muted-2">Nincs találat.</p>');
                            return;
                        }
                        let tbl = '<div class="desktop-only"><table class="table table-bordered"><thead><tr>' +
                            ['Depó','Túraszám','Rendszám','Település','Közterület','Nap','Időintervallum','Műveletek']
                            .map(h => `<th class="text-center">${h}</th>`).join('') +
                            '</tr></thead><tbody>';
                        resp.forEach(it => {
                            tbl += `<tr class="summary" data-depo="${it.depo}" data-tour_number="${it.tour_number}">
                                <td class="text-center">${it.depo}</td>
                                <td class="text-center">${it.tour_number}</td>
                                <td class="text-center">${it.plate_number}</td>
                                <td class="text-center">${it.city}</td>
                                <td class="text-center">${it.street}</td>
                                <td class="text-center">${it.date}</td>
                                <td class="text-center">${it.time_interval}</td>
                                <td class="text-center">
                                    <button class="btn btn-info btn-sm details-btn">Részletek</button>
                                    <button class="btn btn-secondary btn-sm pdf-btn">Túraleírás</button>
                                </td>
                            </tr>`;
                        });
                        tbl += '</tbody></table></div>';
                        const cards = buildMobileCards(resp);
                        $('#results').html(tbl + cards);
                        $('#results .summary').each(function(){
                            const plateRaw = $(this).data('plate') || $(this).find('td').eq(2).text();
                            const plateText = String(plateRaw).normalize('NFD').replace(/[̀-ͯ]/g, '').toLowerCase().trim();
                            if (plateText === 'inaktiv'){ $(this).addClass('inactive-highlight'); }
                        });
                    },
                    error: () => $('#results').html('<p class="text-danger">Hiba történt a keresés során.</p>')
                });
            }

            $('#search-input').autocomplete({
                source: (req, res) => $.getJSON(`${backendUrl}suggest`, { field: 'city', q: req.term }, res),
                minLength: 3,
                delay: 400,
                select: function(event, ui){
                    $(this).val(ui.item.value);
                    $('#street-input').val('');
                    exactCityMatch = true;
                    closeMobileKeyboard();
                    runSearch();
                    return false;
                }
            });

            $('#street-input').autocomplete({
                source: (req, res) => {
                    const city = $('#search-input').val().trim();
                    if (!city) return res([]);
                    $.getJSON(`${backendUrl}suggest`, { field: 'street', q: req.term, city }, res);
                },
                minLength: 2,
                select: function(event, ui){
                    $(this).val(ui.item.value);
                    closeMobileKeyboard();
                    runSearch();
                    return false;
                }
            });

            $('#clear-btn').click(() => {
                $('#search-input,#street-input').val('');
                $('#results,#resultsPlain,#details').empty();
                $('#resultsPlain').hide();
                $('.inactive-highlight').removeClass('inactive-highlight');
                closeMobileKeyboard();
                const input = document.getElementById("search-input");
                if (input) {
                    setTimeout(() => {
                        input.focus();
                        const len = input.value.length;
                        input.setSelectionRange(len, len);
                    }, 0);
                }
            });

            $('#search-input, #street-input').on('keypress', function(e){
                if (e.which === 13){
                    closeMobileKeyboard();
                    runSearch();
                }
            });
            $('#search-btn').click(function(){
                closeMobileKeyboard();
                runSearch();
            });

            $('#map-btn').click(function(){
                closeMobileKeyboard();
                window.open('https://fdriveanalytics.com/ffrost/turainfo/toursmap.html', '_blank', 'noopener,noreferrer');
            });

            $('#results').on('click', '.details-btn', function(){
                closeMobileKeyboard();
                const r = $(this).closest('.summary');
                $.get(`${backendUrl}details`, { depo: r.data('depo'), tour_number: r.data('tour_number') }, function(html){
                    const $det = $('#details');
                    $det.html(html);
                    const allText = $det.text().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
                    if (allText.includes('inaktiv')){
                        $det.addClass('inactive-highlight');
                    } else {
                        $det.removeClass('inactive-highlight');
                    }
                    $('html,body').animate({ scrollTop: $det.offset().top }, 500);
                });
            });

            $('#results').on('click', '.pdf-btn', function(){
                closeMobileKeyboard();
                const r = $(this).closest('.summary');
                window.open(`${backendUrl}pdf?depo=${encodeURIComponent(r.data('depo'))}&tour_number=${encodeURIComponent(r.data('tour_number'))}`);
            });

            $('#results').on('click', '.special-task-btn', async function(e){
                e.preventDefault();
                closeMobileKeyboard();
                const $wrap = $('#results');
                const originalHtml = $wrap.html();
                $wrap.html(`
                    <div class="text-center">
                        <div class="special-progress">Folyamatban<span class="dots"></span></div>
                        <div class="special-hint">A művelet akár percekig is eltarthat.</div>
                    </div>
                `);
                let dotCount = 0; const $dots = $wrap.find('.dots');
                const timer = setInterval(() => { dotCount = (dotCount % 5) + 1; $dots.text('.'.repeat(dotCount)); }, 400);
                try{
                    const res = await fetch(`${backendUrl}${hiddenPath}`, { method: 'GET' });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const blob = await res.blob();
                    let filename = 'osszesites.pdf';
                    const disp = res.headers.get('Content-Disposition');
                    if (disp){
                        const m1 = disp.match(/filename\*=UTF-8''([^;]+)/);
                        const m2 = disp && disp.match(/filename="?([^"]+)"?/);
                        if (m1) filename = decodeURIComponent(m1[1]); else if (m2) filename = m2[1];
                    }
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                } catch(err){
                    alert('Hiba a PDF letöltésénél: ' + err.message);
                } finally{
                    clearInterval(timer); $wrap.html(originalHtml);
                }
            });
        }
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const input = document.getElementById("search-input");
            if (input) { input.focus(); }
        });
    </script>

</body>
</html>
